{{ define "organizations" }}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/output.css" />
    <title>Caesura</title>
    <script src="https://unpkg.com/htmx.org@{{ .Dependencies.HtmxVersion }}/dist/htmx.min.js"></script>
  </head>

  <body class="bg-gray-100">
    {{ template "header" . }}
    <!-- Page Content Placeholder -->
    <div
      id="page-content"
      class="flex flex-col lg:flex-row gap-8 pt-16 max-w-7xl mx-auto px-6"
    >
      <div class="flex-1 flex flex-col gap-8">
        <div class="bg-white rounded-xl shadow-md p-6 space-y-4">
          <label
            for="existing-orgs"
            class="block mb-2 text-sm font-medium text-gray-700"
          >
            {{T "org.select" }}:
          </label>
          <select
            id="existing-orgs"
            name="existing_org"
            class="input mb-4"
            hx-get="/organizations/active/session"
            hx-trigger="change"
            hx-swap="none"
            hx-on::after-request="onOrganizationChange()"
          ></select>
          <form
            class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 gap-2 flex-wrap"
            hx-post="/subscription-page"
            hx-swap="none"
          >
            <label
              for="subscription-plan"
              class="block text-sm font-medium text-gray-700"
              >{{T "org.choose-plan"}}:</label
            >
            <select id="subscription-plan" name="subscription-plan">
              <option value="free">{{T "free"}}</option>
              <option value="monthly">{{T "monthly"}}</option>
              <option value="annual">{{T "annual"}}</option>
            </select>
            <button id="subscribe-btn" type="submit" class="btn btn-primary">
              üí≥ {{T "org.subscripe"}}
            </button>
            <a
              href="/customer-portal"
              id="customer-portal-btn"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-md border border-indigo-600 text-indigo-600 font-medium hover:bg-indigo-50 transition"
            >
              üßæ <span>{{ T "org.manage_billing" }}</span>
            </a>
          </form>
          <button
            id="invite-button"
            type="button"
            class="btn btn-secondary"
            onclick="generateInvite()"
          >
            üìß {{ T "org.invite" }}
          </button>
          <button
            id="delete-btn"
            class="btn bg-error hover:bg-error-700 text-white"
            hx-delete="/organizations"
            hx-swap="none"
            hx-on::after-request="htmx.ajax('GET', '/organizations/options', {target: '#existing-orgs', swap: 'innerHTML'});
                        htmx.ajax('GET', '/session/active-organization/name', {target: '#active-organization', swap: 'innerHTML'})"
            hx-confirm='{{T "org.delete.confirm" }}?'
          >
            üóëÔ∏è {{T "org.delete" }}
          </button>
          <div id="subscription" class="flex">
            <div
              id="expiry-date"
              class="italic text-gray-500"
              hx-get="/subscription"
              hx-target="this"
              hx-swap="innerHTML"
              hx-trigger="load"
            ></div>
          </div>

          <!-- Hidden element just to fasilitate load organization -->
          <div
            hx-get="/organizations/options"
            hx-trigger="load"
            hx-target="#existing-orgs"
            hx-swap="innerHTML"
            class="hidden"
          ></div>
        </div>
        <form
          class="bg-white rounded-xl shadow-md p-6 flex flex-col gap-4"
          hx-post="/organizations"
          hx-swap="none"
          hx-on::after-request="htmx.ajax('GET', '/organizations/options', {target: '#existing-orgs', swap: 'innerHTML'});
                        htmx.ajax('GET', '/session/active-organization/name', {target: '#active-organization', swap: 'innerHTML'})"
        >
          <h2 class="text-2xl font-semibold mb-6 text-gray-800">
            {{ T "org.new-org" }}
          </h2>

          <label for="name" class="block mb-2 text-sm font-medium text-gray-700"
            >{{T "org.name" }}:</label
          >
          <input
            type="text"
            id="name"
            name="name"
            placeholder='{{T "org.new-org.placeholder" }}'
            class="input"
            required
          />

          <button
            type="submit"
            id="create-btn"
            class="btn btn-primary w-full mt-6"
          >
            {{T "org.create" }}
          </button>
        </form>
      </div>
      <div
        class="-full lg:w-1/3 bg-white rounded-xl shadow-md p-6 space-y-4 text-gray-600 text-sm"
      >
        <p class="font-semibold text-gray-700">üí° {{T "org.help"}}?</p>
        <p class="mb-4">{{ T "org.select-existing" }}</p>
        <p class="font-semibold text-gray-700">
          üë• {{ T "org.invite-others" }}?
        </p>
        <p>{{ T "org.invite-explination" }}</p>
        <p class="mb-4">{{ T "org.link-validity" }}.</p>

        <p class="font-semibold text-gray-700">üîó {{ T "org.join" }} ?</p>
        <p class="mb-4">{{ T "org.join-desc" }}</p>

        <p class="font-semibold text-gray-700 mb-2">
          ‚ú® {{ T "org.create-new" }}?
        </p>
        <p class="mb-4">{{ T "org.create-new-desc" }}</p>

        <p class="font-semibold text-gray-700">
          üóëÔ∏è {{ T "org.delete-heading" }}
        </p>
        <p>{{ T "org.delete-desc" }}.</p>
        <p class="mb-2">{{ T "org.accidental-delete" }}</p>
        <p class="mb-4">
          <strong>{{ T "org.note" }}:</strong> {{ T "org.permanent-delete" }}.
        </p>

        <p class="font-semibold text-gray-700">
          ‚è≥ {{ T "org.expired-subscription" }}
        </p>
        <p>{{ T "org.expired-subscription-desc" }}.</p>
      </div>
    </div>
    {{ template "footer" . }}
    <script>
      function generateInvite() {
        const select = document.getElementById("existing-orgs");
        if (select.options.length === 0) {
          alert("No available organizations");
          return;
        }

        const id = select.options[0].value;
        fetch(`/organizations/${id}/invite`)
          .then((res) => res.json())
          .then((data) => {
            const link = data.invite_link;
            if (!link) {
              alert("No invite_link in response");
            }
            navigator.clipboard.writeText(link).then(() => {
              console.log("Clipboard write succeeded");
              alert("Invite link copied to clipboard!");
            });
          });
      }

      function onOrganizationChange() {
        htmx.ajax("GET", "/session/active-organization/name", {
          target: "#active-organization",
          swap: "innerHTML",
        });
        htmx.ajax("GET", "/subscription", {
          target: "#expiry-date",
          swap: "innerHTML",
        });
      }
    </script>
  </body>
  {{end}}
</html>
